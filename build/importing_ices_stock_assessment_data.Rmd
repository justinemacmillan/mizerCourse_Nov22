---
title: "Importing ICES data"
author: "Kennedy Osuka"
date: "2022-10-10"
output:
  html_document:
    code_folding: hide
  '': default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(icesSAG)
library(tidyverse)
library(ggplot2)
```

## ICES Stock Assessment database

icesSAG provides R functions that enable users to access the web services of the ICES Stock Assessment database.

To download the summary data for stocks of a partcular species, the user needs to provide the name of the `species` and the `year` published.

The summary data for `cod` for the `year` 2021 is derived by calling the `getSAG` and specifying the `stock` name and the `year` E.g.

```{r}
summary_data <- getSAG(stock = "cod", year = 2021)
head(summary_data)
```

## Species
But, we are interested in the `biomass` and `landings` of some 17 species over the last ten years i.e. 2012 - 2021. This information is necessary for calibrating and tuning the `mizer` model for the South West fisheries. So we will 
 - create a list of the species and use it in the `getSAG` function.

```{r message = FALSE, warning=FALSE}
sp = c("cod", "megrim", "White anglerfish", "plaice", "sole", "sprat", "whiting", "haddock", "hake", "horse mackerel", "dab", "mackerel","herring", "blue whiting","boarfish", "norway pout")

#getting data for the 17 species
summary_data <- getSAG(stock = sp, year = 2021)

head(summary_data)
```

From the data we then

 - filter data for the years 2012 - 2021
 - filter records where the spawning stock biomass (SSB) and landings are greater than 0.
 - separate the stock into species and ices areas`
 
```{r}
summary_data <- summary_data |>
    #filter the years of interest
    filter(
        Year %in% (2012:2021),
        SSB > 0,
        landings > 0,
        stockSizeDescription %in% c('SSB', 'Spawning Stock Biomass')
    ) |>
    # since some records of some stocks do not have values on total catch
    mutate(cat = landings + discards) |>
    # since some records of some stocks where total catch is provided but
    # landings and discards are missing
    mutate(catches_nw = coalesce(catches, cat))
```


```{r}
data_sp <- summary_data |>
    group_by(fishstock) |>
    # we shall summarise the data using geometric mean
    summarise(
        SSB = exp(mean(log(SSB), na.rm = TRUE)),
        total_catch = exp(mean(log(catches_nw), na.rm = TRUE)),
        F = exp(mean(log(as.numeric(F)), na.rm = TRUE))
    ) |>
    separate(fishstock,
             into = c('species', 'ices_area'),
             sep = 4)
```

Next is to claculate the `yield_observed` and `biomass_observed`, which is done by getting the area in km2 for the ICES statistical areas in which the stock was assessed. 
```{r}
#load area (km2) of the ICES area/divisions
ices_areas <- read.csv("ices_area.csv")

data_sp <- data_sp |>
    left_join(ices_areas, by = ('ices_area' = 'ices_area')) |>
    mutate(yield_observed = total_catch / area,
           biomass_observed = SSB / area) |>
    filter(!is.na(biomass_observed))
```

We note that the `biomass_bserved` for *boc* i.e. boar fish is smaller than `yield_observed`. This is worrying because it implies that there is not enough fish to sustain the fishery. Consequently we need to look for other SSB. In this case we derived SSB from [O’Donnell et al. 2012.] (http://hdl.handle.net/10793/787). There the SSB is stated as 432882 tonnes based on an area coverage of over 306942.11 km².

There is also no SSB for poor cod.

We also make another assumption that the area assessed for blue whiting is similar to mackerel.

Finally we will add a dataframe with species codes

```{r}
 # species are coded differently, therefore we will change the names
species_codes<- read.csv("species_codes.csv")

data_sp <- data_sp |>
    left_join(species_codes, by = c('species' = 'code_ices')) |> 
    filter(!(species == 'cod.' & ices_area == '27.5a')) |> 
    select(Species, biomass_observed, yield_observed) |>
    rename('species' = 'Species')
# this code can be added to update the biomass_observed for boarfish
# |>mutate(biomass_observed = ifelse(species == "Boarfish",  432882/306942.11, biomass_observed))
  
write.csv(data_sp, "celtic_sea_ssb.csv")
```

