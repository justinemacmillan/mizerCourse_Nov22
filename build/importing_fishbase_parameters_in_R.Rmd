---
title: "Import Fishbase Life History Parameters"
author: "Kennedy Osuka"
date: "2022-10-21"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
#load packages
remotes::install_github("ropensci/rfishbase")

library(rfishbase)
library(dplyr)
load("species_rankdf.Rdata")
```

## FishBase in R
An R package `rfishbase` is available for importing data from FishBase. The original rfishbase package is described in Boettiger et al. (2012).

All fishbase tables can be accessed by name using the `fb_tbl()` function. But first it is important to create a list of either the `Genus` or `species` one is interested in.

```{r}
## Specify the genus/ species you are interested in
## Here is an example for Genus 
fish <- species_list(Genus = c("Gadus", "Solea"))

## An example for species
fish <- species_list(Species = c('Clupea harengus','Sprattus sprattus','Gadus morhua','Melanogrammus aeglefinus', 'Merlangius merlangus', 'Micromesistius poutassou','Trisopterus esmarkii', 'Trisopterus minutus', 'Merluccius merluccius', 'Lophius piscatorius','Trachurus trachurus','Scomber scombrus', 'Limanda limanda', 'Pleuronectes platessa','Lepidorhombus whiffiagonis', 'Solea solea', 'Capros aper'))

```

## How many species we looking at? 
To know how many species one is looking at, especially if you had specify the genus, you can run this code.
```{r}
length(fish) 
```

One can also check the names of the traits that are available on FishBase

```{r}
#Traits 
traits <-  species(fish)
#what sort of traits are there? 
colnames(traits) 
```

There are 101 traits. But there are none on Von Bertalanffy. For life history parameters we need a function called `popgrowth()`

```{r}
## Life history
pop <- popgrowth(fish)
colnames(pop) 
```

Running this results to 80 parameters with parameter 19 being on Von Bertalanffy `K`. Of course we can select the parameters we are interested in using `dplyr` operators.

```{r}
#select traits you are interested
pop_short <- pop %>%
  select(Species, Sex, StockCode, Loo, SE_Loo, SD_Loo, K, SE_K, SD_K, M, 
         Lm, TypeLm, LmFemale) %>%
  arrange(Species)

head(pop_short) #oof. lots of NAs. 

```

How many have SD or SE on Loo?
```{r}
nrow(filter(pop_short, !is.na(SE_Loo)|!is.na(SD_Loo)))
```

Richard has provided Rdata file `species_rankdf.Rdata` with the top 60 species in the survey data (ranked by number of individuals caught).  The following codes extract von Bertalanffy growth parameters (Linf, k) from Fishbase. The data will be used  to extend the results on production rate. 
```{r}
species_sw = c('Micromesistius poutassou',
'Melanogrammus aeglefinus',
'Capros aper',
'Trachurus trachurus',
'Scomber scombrus',
'Merlangius merlangus',
'Merluccius merluccius',
'Argentina silus',
'Eutrigla gurnardus',
'Scyliorhinus canicula',
'Galeus melastomus',
'Trisopterus esmarkii',
'Helicolenus dactylopterus',
'Clupea harengus',
'Lophius piscatorius',
'Trisopterus minutus',
'Gadiculus argenteus',
'Phycis blennoides',
'Lepidorhombus whiffiagonis',
'Squalus acanthias',
'Argentina sphyraena',
'Pleuronectes platessa',
'Molva macrophthalma',
'Sprattus sprattus',
'Raja montagui',
'Lepidorhombus boscii',
'Limanda limanda',
'Gadus morhua',
'Chelidonichthys cuculus',
'Chimaera monstrosa',
'Lophius budegassa',
'Glyptocephalus cynoglossus',
'Leucoraja naevus',
'Lepidion eques',
'Solea solea',
'Raja clavata',
'Zeus faber',
'Callionymus lyra',
'Hippoglossoides platessoides',
'Microstomus kitt',
'Engraulis encrasicolus',
'Mustelus asterias',
'Microchirus variegatus',
'Sardina pilchardus',
'Trisopterus luscus',
'Chelidonichthys lucerna',
'Hoplostethus mediterraneus',
'Etmopterus spinax',
'Coelorinchus caelorhincus',
'Mullus surmuletus',
'Trachyrincus scabrus',
'Buglossidium luteum',
'Arnoglossus imperialis',
'Epigonus telescopus',
'Callionymus maculatus',
'Spondyliosoma cantharus',
'Arnoglossus laterna',
'Nezumia aequalis',
'Malacocephalus laevis',
'Maurolicus muelleri')

## Life history
pop_all <- popgrowth(species_sw)
colnames(pop_all) 
## create vonber dataframe
vonber_df<- pop_all|> group_by(Species)|> summarise(no_records = n(), no_stocks = n_distinct(StockCode), min_Loo = min(Loo), max_Loo = max(Loo), mean_Loo = mean(Loo), min_K = min(K), max_K = max(K), mean_K = mean(K))

## write a csv file
write.csv(vonber_df, "vonber_df.csv")
```

